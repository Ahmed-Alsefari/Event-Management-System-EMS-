
package ems.app.service;

import ems.app.model.Event;
import ems.app.model.Notification;
import ems.app.repository.NotificationRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;
import java.util.List;

@Service
@RequiredArgsConstructor
public class NotificationService {
    private final NotificationRepository notificationRepository;

    @Autowired(required = false)
    private JavaMailSender mailSender;

    public Notification sendNotification(Notification n) {
        Notification saved = notificationRepository.save(n);

        if (mailSender != null) {
            try {
                SimpleMailMessage msg = new SimpleMailMessage();
                msg.setTo(n.getUser().getEmail());
                msg.setSubject(n.getSubject());
                msg.setText(n.getMessage());
                mailSender.send(msg);
            } catch (Exception e) {
                System.err.println("Failed to send email: " + e.getMessage());
            }
        }

        return saved;
    }

    // SEND EVENT STATUS EMAIL (NEW)
    public void sendEventStatusEmail(Event event, String status) {
        if (mailSender == null) {
            System.out.println("⚠️ Mail sender not configured. Email not sent.");
            return;
        }

        try {
            SimpleMailMessage msg = new SimpleMailMessage();

            // NOTE: You should link Event to User in database to get customer email
            // For now, using a placeholder. Update this when you add User to Event model
            msg.setTo("customer@example.com");

            msg.setSubject("Event Status Update: " + event.getTitle());

            String messageText = String.format(
                    "Hello,\n\n" +
                            "Your event booking has been updated:\n\n" +
                            "Event: %s\n" +
                            "Date: %s\n" +
                            "Location: %s\n" +
                            "Attendees: %d\n" +
                            "Status: %s\n\n" +
                            "Thank you for using our Event Management System!\n\n" +
                            "Best regards,\n" +
                            "EMS Team",
                    event.getTitle(),
                    event.getDate(),
                    event.getLocation(),
                    event.getSeats(),
                    status
            );

            msg.setText(messageText);
            mailSender.send(msg);

            System.out.println("✅ Email sent successfully to customer!");
        } catch (Exception e) {
            System.err.println("❌ Failed to send email: " + e.getMessage());
        }
    }

    public List<Notification> findByUser(Long userId) {
        return notificationRepository.findByUserId(userId);
    }
}
